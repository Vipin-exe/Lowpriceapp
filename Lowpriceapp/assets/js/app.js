const CART_KEY='lp_cart'
const PAY_KEY='lp_pay_method'
const fmt=v=>`RM${Number(v).toFixed(2)}`
const el=q=>document.querySelector(q)
const els=q=>Array.from(document.querySelectorAll(q))
const loadCart=()=>{try{return JSON.parse(localStorage.getItem(CART_KEY)||'[]')}catch{return[]}}
const saveCart=c=>localStorage.setItem(CART_KEY,JSON.stringify(c))
const badge=()=>{const c=loadCart();const b=el('#cartBadge');if(b)b.textContent=String(c.reduce((s,i)=>s+i.qty,0))}
const addProduct=(id,name,price,color)=>{const c=loadCart();const f=c.find(x=>x.id===id);if(f){f.qty+=1}else{c.push({id,name,price:Number(price),qty:1,color})}saveCart(c);badge()}
const removeProduct=id=>{const c=loadCart().filter(x=>x.id!==id);saveCart(c);badge()}
const updateQty=(id,qty)=>{const c=loadCart();const f=c.find(x=>x.id===id);if(!f)return;f.qty=Math.max(1,qty);saveCart(c);badge()}
const subtotal=c=>c.reduce((s,i)=>s+i.price*i.qty,0)
const shipping=c=>c.length?5:0
const payable=c=>subtotal(c)+shipping(c)
const onHome=()=>{els('.product-card').forEach(card=>{const id=card.dataset.id;const name=card.dataset.name;const price=card.dataset.price;const media=card.querySelector('.product-media');const color=media.classList.contains('blue')?'blue':media.classList.contains('gray')?'gray':'pink';card.querySelector('[data-action="add"]').addEventListener('click',()=>addProduct(id,name,price,color))});badge()}
const renderCart=()=>{const list=el('#cartList');if(!list)return;const c=loadCart();list.innerHTML='';c.forEach(i=>{const row=document.createElement('div');row.className='cart-item';const thumb=document.createElement('div');thumb.className='cart-thumb';if(i.color==='blue')thumb.style.background='linear-gradient(180deg,#c7dcff,#fff)';if(i.color==='gray')thumb.style.background='linear-gradient(180deg,#e6e6e6,#fff)';row.appendChild(thumb);const info=document.createElement('div');info.className='cart-info';const name=document.createElement('div');name.className='cart-name';name.textContent=i.name;const price=document.createElement('div');price.className='cart-price';price.textContent=fmt(i.price);const qty=document.createElement('div');qty.className='qty-row';const minus=document.createElement('button');minus.className='qty-btn';minus.textContent='-';const q=document.createElement('span');q.textContent=i.qty;const plus=document.createElement('button');plus.className='qty-btn';plus.textContent='+';qty.append(minus,q,plus);info.append(name,price,qty);row.appendChild(info);const remove=document.createElement('button');remove.className='remove-btn';remove.textContent='Remove';row.appendChild(remove);list.appendChild(row);minus.addEventListener('click',()=>{updateQty(i.id,i.qty-1);renderCart()});plus.addEventListener('click',()=>{updateQty(i.id,i.qty+1);renderCart()});remove.addEventListener('click',()=>{removeProduct(i.id);renderCart()})});const sub=subtotal(c);el('#cartSubtotal').textContent=fmt(sub);el('#cartShipping').textContent=fmt(shipping(c));el('#cartTotal').textContent=fmt(payable(c));const btn=el('#checkoutBtn');if(btn)btn.onclick=()=>{if(!c.length)return;location.href='payment-select.html'}}
const renderOrder=()=>{const list=el('#orderItems');if(!list)return;const c=loadCart();list.innerHTML='';c.forEach(i=>{const row=document.createElement('div');row.className='order-item';const left=document.createElement('span');left.textContent=`${i.name} Ã—${i.qty}`;const right=document.createElement('span');right.textContent=fmt(i.price*i.qty);row.append(left,right);list.appendChild(row)});el('#itemsTotal').textContent=fmt(subtotal(c));el('#shippingTotal').textContent=fmt(shipping(c));el('#payableTotal').textContent=fmt(payable(c));const confirm=el('#confirmOrderBtn');if(confirm)confirm.onclick=()=>{localStorage.removeItem(CART_KEY);badge();location.href='index.html'};const back=el('#backHomeBtn');if(back)back.onclick=()=>location.href='index.html'}
const onLogin=()=>{badge();const tabs=els('[data-login-tab]');const btn=el('#sendCodeBtn');let mode='whatsapp';tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');mode=t.dataset.loginTab;btn.textContent=mode==='whatsapp'?'Send Code Via WhatsApp':'Send Code Via SMS'});const finger=el('#fingerSwitch');if(finger)finger.onchange=()=>{}}
const onPaymentSelect=()=>{badge();const c=loadCart();const first=c[0];if(!first)return;const container=el('#psItem');if(container){container.querySelector('.name').textContent=first.name;container.querySelector('.price').textContent=fmt(first.price*first.qty);const qtyVal=container.querySelector('.qty-val');if(qtyVal)qtyVal.textContent=first.qty;const minus=container.querySelector('.minus');const plus=container.querySelector('.plus');if(minus)minus.onclick=()=>{updateQty(first.id,first.qty-1);onPaymentSelect()};if(plus)plus.onclick=()=>{updateQty(first.id,first.qty+1);onPaymentSelect()}}const cards=els('.method-card');let method=localStorage.getItem(PAY_KEY)||'cod';cards.forEach(card=>{if(card.dataset.method===method)card.classList.add('active');else card.classList.remove('active');card.onclick=()=>{cards.forEach(x=>x.classList.remove('active'));card.classList.add('active');method=card.dataset.method;localStorage.setItem(PAY_KEY,method)}});const btn=el('#psContinueBtn');if(btn)btn.onclick=()=>location.href='payment-pay.html'}
const onPaymentPay=()=>{badge();const c=loadCart();const first=c[0];if(!first)return;const container=el('#ppItem');if(container){container.querySelector('.name').textContent=first.name;container.querySelector('.price').textContent=fmt(first.price*first.qty);const qtyVal=container.querySelector('.qty-val');if(qtyVal)qtyVal.textContent=first.qty;const minus=container.querySelector('.minus');const plus=container.querySelector('.plus');if(minus)minus.onclick=()=>{updateQty(first.id,first.qty-1);onPaymentPay()};if(plus)plus.onclick=()=>{updateQty(first.id,first.qty+1);onPaymentPay()}}const count=c.reduce((s,i)=>s+i.qty,0);el('#ppItemsCount').textContent=String(count);const sub=subtotal(c);el('#ppItemsTotal').textContent=fmt(sub);el('#ppShipFee').textContent=fmt(shipping(c));el('#ppDiscount').textContent=fmt(0);el('#ppSubTotal').textContent=fmt(payable(c));const methodSelect=el('#ppMethod');const saved=localStorage.getItem(PAY_KEY)||'cod';if(methodSelect){methodSelect.value=saved;methodSelect.onchange=()=>localStorage.setItem(PAY_KEY,methodSelect.value)}const payBtn=el('#ppPayBtn');if(payBtn)payBtn.onclick=()=>{localStorage.removeItem(CART_KEY);badge();location.href='payment-complete.html'}}
const onPaymentComplete=()=>{badge();const btn=el('#pcContinueBtn');if(btn)btn.onclick=()=>location.href='index.html'}
const onAccount=()=>{badge();const settings=el('#accSettingsBtn');if(settings)settings.onclick=()=>location.href='settings.html'}
document.addEventListener('DOMContentLoaded',()=>{if(el('.product-grid'))onHome();if(el('.cart-container'))renderCart();if(el('.order-container'))renderOrder();if(el('.login-container'))onLogin();if(el('.pay-select-container'))onPaymentSelect();if(el('.pay-pay-container'))onPaymentPay();if(el('.pay-complete-container'))onPaymentComplete();if(el('.account-container'))onAccount()})
